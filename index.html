<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Unified Data Layer for Large-Scale Single-Cell, Spatial and Bulk Immunomics • immundata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="A Unified Data Layer for Large-Scale Single-Cell, Spatial and Bulk Immunomics">
<meta property="og:description" content="Provides a unified data layer for single-cell, spatial and bulk T-cell and B-cell immune receptor repertoire data. Think AnnData or SeuratObject, but for AIRR data.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">immundata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.3.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://immunomind.com" class="external-link">ImmunoMind</a>
</li>
<li>
  <a href="https://github.com/immunomind/immunarch" class="external-link">
    <span class="fa fa-github"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="contents col-md-9">


<div class="section level1">
<div class="page-header"><h1 id="id_-immundata--a-unified-data-layer-for-large-scale-single-cell-spatial-and-bulk-immunomics-in-r">🦋 <code>immundata</code> – A unified data layer for large-scale single-cell, spatial and bulk immunomics in R<a class="anchor" aria-label="anchor" href="#id_-immundata--a-unified-data-layer-for-large-scale-single-cell-spatial-and-bulk-immunomics-in-r"></a>
</h1></div>
<p><code>immundata</code> introduces the <code>ImmunData</code> data structure – think <a href="https://github.com/scverse/anndata" class="external-link">AnnData</a> or <a href="https://github.com/satijalab/seurat-object/" class="external-link">SeuratObject</a> but for immune repertoires – so you can:</p>
<ul>
<li><p>Store tens of millions of immune receptors plus metadata in one place;</p></li>
<li><p>Compute receptor- and repertoire-level statistics leveraging single-cell, spatial, immunogenicity or any other annotations;</p></li>
<li><p>Work seamlessly with datasets that don’t fit in memory;</p></li>
<li><p>Run the same workflow on a laptop, server, or cloud instance.</p></li>
</ul>
<hr>
<div class="section level2">
<h2 id="id_-why-immundata">🤔 Why <code>immundata</code>?<a class="anchor" aria-label="anchor" href="#id_-why-immundata"></a>
</h2>
<p>Modern immunomics no longer ends at a couple of FASTQ files and a bar plot:</p>
<ul>
<li><p>We now blend bulk AIRR-seq, single-cell V(D)J + GEX, spatial transcriptomics, clinical metadata and public databases – often inside the same analysis notebook;</p></li>
<li><p>Pipelines that handle gigabytes today face deca-gigabytes after the next experiment;</p></li>
<li><p>The same immune repertoire dataset must power multiple plots, dashboards, deep learning models and be reproducible months (years, ideally) later.</p></li>
</ul>
<p><code>immundata</code> is the data-engineering backbone powered by <a href="https://arrow.apache.org/docs/r/" class="external-link">Arrow</a>, <a href="https://duckdb.org/" class="external-link">DuckDB</a>, and <a href="https://duckplyr.tidyverse.org/" class="external-link">duckplyr</a>. It lets you scale, mix and, ultimately, analyse annotated AIRR data without rewriting your biology workflow from scratch each time the dataset grows 10×.</p>
<hr>
<blockquote>
<p>[!IMPORTANT] This README is huge. I’m not kidding. Please consider using navigation.</p>
</blockquote>
<ul>
<li>🤔 <a href="#id_-why--immundata-">Why <code>immundata</code>?</a>
</li>
<li>📦 <a href="#id_-installation">Installation</a>
</li>
<li>⚡ <a href="#id_-quick-start">Quick Start</a>
</li>
<li>🧬 <a href="#id_-workflow-explained">Workflow Explained</a>
</li>
<li>💾 <a href="#id_-ingestion">Ingestion</a>
<ul>
<li><a href="#load-airr-data">Load AIRR data</a></li>
<li><a href="#working-with-metadata-table-files">Working with metadata table files</a></li>
<li><a href="#receptor-schema">Receptor schema</a></li>
<li><a href="#repertoire-schema">Repertoire schema</a></li>
<li><a href="#pre--and-post%E2%80%91processing-strategies">Pre‑ and post‑processing strategies</a></li>
<li><a href="#managing-output--intermediate-immundata-files">Managing output &amp; intermediate ImmunData files</a></li>
<li><a href="#writing-immundata-objects-to-disk">Writing ImmunData objects to disk</a></li>
</ul>
</li>
<li>🧿 <a href="#id_-immundata-object">ImmunData Object</a>
</li>
<li>🛠 <a href="#id_-transformation">Transformation</a>
<ul>
<li><a href="#filter">Filter</a></li>
<li><a href="#annotate">Annotate</a></li>
<li><a href="#modify">Modify</a></li>
</ul>
</li>
<li>📈 <a href="#id_-analysis">Analysis</a>
<ul>
<li><a href="#basic-analysis-using--immundata-">Basic analysis using <code>immundata</code></a></li>
<li><a href="#advanced-analysis-using--immunarch-">Advanced analysis using <code>immunarch</code></a></li>
</ul>
</li>
<li>🧩 <a href="#id_-use-cases">Use Cases</a>
<ul>
<li><a href="#bulk---repseq-airrseq">Bulk – RepSeq, AIRRSeq</a></li>
<li><a href="#paired-chain---scvdjseq-or-other-technologies">Paired-chain – scVDJseq or other technologies</a></li>
<li><a href="#single-cell---scrnaseq-scvdjseq-sctcrseq-scbcrseq">Single-cell – scRNAseq, scVDJseq, scTCRseq, scBCRseq</a></li>
<li><a href="#spatial---spatial-transcriptomics-and-cell-coordinates">Spatial – spatial transcriptomics and cell coordinates</a></li>
<li><a href="#annotate-immune-receptors-using-external-airr-databases">Annotate immune receptors using external AIRR databases</a></li>
<li><a href="#immunogenicity----run-external-tools-such-as-tcrdist-to-annotate-immundata">Immunogenicity – run external tools such as TCRdist to annotate ImmunData</a></li>
<li>
<a href="#hybrid-datasets">Hybrid datasets</a>
<ul>
<li><a href="#multi-locus-data">Multi-locus data</a></li>
<li><a href="#multiple-contigs-for-tcr">Multiple contigs for TCR</a></li>
<li><a href="#bcr-heavy-chains-with-multiple-light-chains">BCR-heavy chains with multiple light chains</a></li>
<li><a href="#bulk-and-single-cell-data-integration">Bulk and single-cell data integration</a></li>
</ul>
</li>
</ul>
</li>
<li>🧠 <a href="#id_-advanced-topics">Advanced Topics</a>
</li>
<li>🏷 <a href="#id_-about">About</a>
<ul>
<li><a href="#citation">Citation</a></li>
<li><a href="#license">License</a></li>
<li><a href="#author-and-contributors">Author and contributors</a></li>
<li><a href="#commercial-usage">Commercial usage</a></li>
</ul>
</li>
<li>🤔 <a href="#id_-faq">FAQ</a>
</li>
</ul>
<hr>
<blockquote>
<p>[!WARNING] <code>immundata</code> is still in the <strong>0.x</strong> series. Until we reach 1.0.0, breaking changes may appear in any minor/patch update (e.g. 0.2.1 → 0.3.0). When you attach the package, sometimes you’ll see startup messages summarising the most important changes – please read them. If something that used to work suddenly fails, check the updated documentation (<code>?function_name</code>) first.</p>
<p><strong>Tip:</strong> if your analysis depends on a specific behaviour, pin the exact version with <code>renv</code> or use <code>pak</code> for installation:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"immunomind/immundata@0.2.1"</span><span class="op">)</span></span></code></pre></div>
<p>I’ll keep publishing tagged releases with full docs so you can always roll back if needed.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="id_-installation">📦 Installation<a class="anchor" aria-label="anchor" href="#id_-installation"></a>
</h2>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<p>Before installing any release or pre-release version of <code>immundata</code>, please install <code>pak</code> that will simplify the installation of any package, not just <code>immundata</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"pak"</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"https://r-lib.github.io/p/pak/stable/%s/%s/%s"</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">pkgType</span>, <span class="fu"><a href="https://rdrr.io/r/base/Version.html" class="external-link">R.Version</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">os</span>, <span class="fu"><a href="https://rdrr.io/r/base/Version.html" class="external-link">R.Version</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">arch</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>More info if needed is available on <a href="https://pak.r-lib.org/#arrow_down-installation" class="external-link">pak website</a>.</p>
</div>
<div class="section level3">
<h3 id="install-the-latest-version">Install the latest version<a class="anchor" aria-label="anchor" href="#install-the-latest-version"></a>
</h3>
<p>To install the latest release of <code>immundata</code>, simply run:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"immunomind/immundata"</span><span class="op">)</span></span></code></pre></div>
<p>Mind that this will install the package from our GitHub instead of CRAN. This method is much preferred due to limitations of CRAN and reliance on other packages, which are distributed via <code>pak</code> as well.</p>
</div>
<div class="section level3">
<h3 id="other-installation-options">Other installation options<a class="anchor" aria-label="anchor" href="#other-installation-options"></a>
</h3>
<p>We will periodically release <code>immundata</code> on CRAN. To install it from CRAN, run</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"immundata"</span><span class="op">)</span></span></code></pre></div>
<p>If you are willing to try unstable yet bleeding edge features, or if there are some hot fix for your open GitHub ticket, please install the development version:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"immunomind/immundata@dev"</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="id_-quick-start">⚡ Quick Start<a class="anchor" aria-label="anchor" href="#id_-quick-start"></a>
</h2>
<blockquote>
<p>[!TIP] Interested in specific use cases, e.g., analyse cell clusters from single-cell data, work with paired-chain data, search for matches in databases with condition-associated TCR and BCR data?</p>
<p>Take a look at the <a href="#id_-use-cases">🧩 Use Cases section</a> below.</p>
</blockquote>
<p>Use the immune repertoire data packaged with <code>immundata</code> for quick dive. Replace <code>system.file</code> calls with your local file paths to run the code on your data.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Metadata table with additional sample-level information</span></span>
<span><span class="va">md_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"metadata.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Two sample files</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"sample_0_1k.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"sample_1k_2k.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Read the metadata table</span></span>
<span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_metadata.html">read_metadata</a></span><span class="op">(</span><span class="va">md_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pass the file paths and the metadata table to the function to read the dataset into R</span></span>
<span><span class="va">imdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span>path          <span class="op">=</span> <span class="va">samples</span>,</span>
<span>                           schema        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3_aa"</span>, <span class="st">"v_call"</span><span class="op">)</span>,</span>
<span>                           metadata      <span class="op">=</span> <span class="va">md</span>,</span>
<span>                           output_folder <span class="op">=</span> <span class="st">"./immundata-quick-start"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the resultant object in the detailed yet manageable format</span></span>
<span><span class="va">imdata</span></span>
<span></span>
<span><span class="co"># Check the folder immundata created - this is where your dataset resides now</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">"./immundata-quick-start"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read sections below for data analysis</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="id_-workflow-explained">🧬 Workflow Explained<a class="anchor" aria-label="anchor" href="#id_-workflow-explained"></a>
</h2>
<p><code>immundata</code> splits the workflow into two clear phases:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Ingestion</strong> – convert your AIRR files into a special format saved on disk, and then read them to a tidy <code><a href="reference/ImmunData.html">immundata::ImmunData</a></code> object</p></li>
<li><p><strong>Transformation</strong> – explore, annotate, filter and compute on that object</p></li>
</ol>
<p>Before we go into more details for each of the phase, there are three straightforward yet essential <code>immundata</code> concepts to keep in mind. These concepts set it apart from data-frame-based AIRR libraries. By extension, the concepts affect how you would work with and even <em>think</em> about the data analysis in other packages such as <code>immunarch</code> which use <code>immundata</code> as a backbone for computations.</p>
<div class="section level3">
<h3 id="concepts">Concepts<a class="anchor" aria-label="anchor" href="#concepts"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p><strong>Units: chain -&gt; barcode -&gt; receptor</strong></p>
<table class="table">
<colgroup>
<col width="5%">
<col width="31%">
<col width="42%">
<col width="20%">
</colgroup>
<thead><tr class="header">
<th>Term</th>
<th>In plain English</th>
<th>How <strong>immundata</strong> represents it</th>
<th><strong>Role</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Chain</strong></td>
<td>A single V(D)J transcript (e.g. <em>TRA</em> or <em>IGH</em>) coming from one read or contig.</td>
<td>One row in the physical table <code>idata$annotations</code>; retains <code>locus</code>, <code>cdr3</code>, <code>umis</code>/<code>reads</code> and other crucial rearrangement characteristics.</td>
<td>
<strong>Raw data unit</strong> – atomic building block.</td>
</tr>
<tr class="even">
<td><strong>Barcode / Cell</strong></td>
<td>The droplet (10x), spot (Visium) or well a chain was captured in.</td>
<td>Column <code>imd_barcode</code>.</td>
<td>
<strong>Physical bundle</strong> – groups chains that share a capture compartment.</td>
</tr>
<tr class="odd">
<td><strong>Receptor</strong></td>
<td>The biological receptor you analyse: a single chain <strong>or</strong> a paired set (αβ, Heavy-Light) from one cell.</td>
<td>Virtual table <code>idata$receptors</code>; unique ID <code>imd_receptor_id</code>.</td>
<td>
<strong>Logical unit</strong> – minimal object for AIRR statistics.</td>
</tr>
<tr class="even">
<td><strong>Repertoire</strong></td>
<td>A set of receptors grouped by sample, donor, cluster, etc.</td>
<td>Physical table <code>idata$repertoires</code>; unique ID <code>imd_repertoire_id</code>; grouping columns you choose.</td>
<td>
<strong>Aggregate unit</strong> – higher-level grouping for comparative analysis.</td>
</tr>
</tbody>
</table>
<p><strong>Chain</strong> is one V(D)J rearranged molecule / contig / chemistry read (e.g. a single TRA, TRB, IGH, IGL). This is a minimally possible data unit, a building block of everything. In case of single-chain data, chain is the same as barcode. Never changes after ingest; you can always drill back to the exact sequence.</p>
<p><strong>Barcode</strong> is a physical container that stores zero, one, or many chains. In single‑cell it’s a droplet == cell; in bulk it’s the same as assembled “clonotype”; in spatial it’s a spot. Barcode sometimes equals to cell. It is a biological unit that “stores” relevant biological data and uses for aggregation of same chains and computing counts of same receptors coming from different barcodes. Inherits any per‑cell / per‑sample metadata you add.</p>
<p><strong>Receptor</strong> is a logical unit. A logical grouping of chains that you want to treat as one biological receptor. This is a minimal unit for AIRR statistics. There are two components to it: receptor features and receptor chains, alltogether comprising a receptor schema that you define in order to do downstream analysis. Receptor features are usually CDR3 amino acid sequences or CDR3 amino acid sequences plus Variable gene segment. Receptor chains can be: single chain, α+β pair, heavy+light pair, or even all chains sharing the same CDR3/V/J.</p>
<p>To summarise: chains are how <code>immundata</code> stores the information, barcodes bundle chains together, and receptors are the minimal units on which repertoire statistics are computed.</p>
</li>
<li>
<p><strong>Aggregation: defining receptors and repertoires</strong></p>
<p>The moment data leave an AIRR-assembly tool such as <strong>Cell Ranger</strong>, you are handed an ocean of individual V(D)J chains, yet every biological question you care about is phrased in terms of receptors (“this αβ TCR”) or repertoires (“all receptors from donor A on day 30”). As with “receptors as logical units”, the underlying assumption the second concept is based upon is <em>researchers work with rearrangements but think in receptors</em>. <code>immundata</code> formalises the climb from raw chains to those higher-order concepts through <strong>controlled aggregation</strong> – explicit, user-defined rules that transform data without obscuring their origin.</p>
<p>The function <code><a href="reference/agg_receptors.html">agg_receptors()</a></code> lets you declare what <em>one receptor</em> means in your study. You choose a schema – perhaps “pair chains that share a barcode and have complementary α and β loci” or “group every IGH with whatever IGL shares the same CDR3 amino-acid sequence.” The function re-aggregates the data and returns a new <code>ImmunData</code> object, so you keep the previous receptor definition intact; every receptor now has a stable identifier and can be traced back to its constituent chains and barcode. There is no need to touch the downstream pipeline – just change the input.</p>
<p>The function <code><a href="reference/agg_repertoires.html">agg_repertoires()</a></code> states how receptors should be bundled into biologically meaningful cohorts: all receptors from a biopsy, from a therapy responder, from a single-cell-defined cluster, or any combination of metadata columns. The result is a physical <code>idata$repertoires</code> table with basic statistics (numbers of chains, barcodes, and unique receptors), again preserving direct links to the receptors it aggregates.</p>
<p>Because these aggregation steps live in your pipeline rather than being buried inside helper functions, they deliver two major pay-offs:</p>
<ul>
<li><p><strong>Convenience with rigour:</strong> you can run high-level computations – Jaccard coefficients, diversity indices – knowing that the exact receptor definition is stored alongside the result, so you never mis-specify parameters such as <code>"cdr3+v"</code>;</p></li>
<li><p><strong>Provenance and data lineage by design:</strong> every receptor records every chain it contains, every repertoire records every receptor, and the full recipe is stored in the object’s metadata. Six months later – or six reviewers later – you can trace any summary statistic back to the precise chains that produced it, enabling fully reproducible pipelines with no hidden transformations.</p></li>
</ul>
</li>
<li>
<p><strong>Pipeline-based execution: immutability and materialisation</strong></p>
<p>The explicit data lineage we talked about in concepts 1 &amp; 2 pays its dividend only if every step is re-playable. That is why <code>immundata</code> treats an analysis as a <em>pipeline of immutable transformations</em>. Each function returns a fresh <code>ImmunData</code> object, leaving the parent untouched; the full chain of objects records how the data travelled from raw chains to final statistics.</p>
<p>Because immunomics datasets started to regularly outgrow RAM, those objects do <strong>not</strong> live in memory by default. Their tables are persisted as column-compressed Parquet files and “materialised” – pulled into RAM – only when a computation truly needs them, typically to crunch a subset or to emit the final numbers such as repertoire-overlap indices. For a 10 GB dataset that fits in memory, this behaviour is invisible: DuckDB streams the file, you get an in-memory frame, and life goes on. For a 100 GB experiment, the same code still runs; the heavy joins spill to disk, and the intermediate results are cached so downstream steps can reuse them without recomputation.</p>
<p>Thinking in pipelines therefore means two things:</p>
<ul>
<li><p><strong>Cache what matters:</strong> create intermediate <code>ImmunData</code> objects when you hit an expensive step, and write them to disk; the next run can pick up from there. A prime example of this a computing edit distances to some patterns or sequences.</p></li>
<li><p><strong>Assume re-execution:</strong> any colleague (or future-you on a bigger cluster) should be able to rerun <code>pipeline.R</code> end-to-end without interactive tinkering and arrive at the same result byte-for-byte.</p></li>
</ul>
<p>All of this engineering should stay behind the curtain. Downstream packages that adopt <code>immundata</code> as their backbone should expose high-level verbs such as <code>compute_diversity()</code> or <code>plot_overlap()</code>; the user need not touch <code>ImmunData</code>, DuckDB, or Parquet. In the ideal scenario they never learn that an on-disk database powers their workflow – and they never have to.</p>
<p>Leave the data engineering to the data engineers (and, sadly, bioinformaticians – I feel your pain); keep your focus or the focus of your users on the biology. It is sophisticated enough already.</p>
</li>
</ol>
<p>And now, let’s dive into how you work with <code>immundata</code>.</p>
</div>
<div class="section level3">
<h3 id="phase-1-ingestion">Phase 1: Ingestion<a class="anchor" aria-label="anchor" href="#phase-1-ingestion"></a>
</h3>
<pre><code>      ┌───────┐
      │ files │
      └───────┘
          │
          ▼
   read_metadata()    ──── Read metadata
          │
          ▼
  read_repertoires()  ──┬─ Read repertoire files (!)
          │             │      ▼
          │             │  Preprocess
          │             │      ▼
          │             │  Aggregate receptors (!)
          │             │      ▼
          │             │  Postprocess
          │             │      ▼
          │             │  Aggregate repertoires #1
          │             │      ▼
          │             └─ Write data on disk (!)
          ▼
   agg_repertoires()  ──── Aggregate repertoires #2
          │
          ▼
    ┌───────────┐
    │ ImmunData │
    └───────────┘</code></pre>
<p>Steps marked with <code>(!)</code> are non-optional.</p>
<p>The goal of the <strong>ingestion phase</strong> is to turn a folder of AIRR-seq files into an immutable on-disk <code>ImmunData</code> dataset.</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Read metadata:</strong></p>
<p><code><a href="reference/read_metadata.html">read_metadata()</a></code> pulls in any sample- or donor-level information, such as therapy arm, HLA type, age, etc., and stores it in a data frame that we can pass to the main reading functions <code>read_repertoires</code>. Attaching this context early means every chain you read later already “knows” which patient or time-point it belongs to.</p>
<p>You can safely skip it if you don’t have per-sample pr per-donor metadata.</p>
</li>
<li>
<p><strong>Read repertoire files:</strong></p>
<p><code><a href="reference/read_repertoires.html">read_repertoires()</a></code> streams Parquet/CSV/TSV files straight into DuckDB that powers <code>ImmunData</code> objects.</p>
</li>
<li>
<p><strong>Preprocess:</strong></p>
<p>During the read step you may pass a <code>preproc = recipe</code> argument to <code>read_repertoires</code> to preprocess data before aggregating receptors: drop unused columns, strip non-productive sequences, translate field names to the AIRR schema, de-duplicate contigs, etc. Because this logic is declarative, re-runs produce identical results.</p>
</li>
<li>
<p><strong>Aggregate receptors:</strong></p>
<p>Receptor schema is how you define a receptor – a logical unit of analysis. The <code>read_repertoires</code> collapses chains into receptors accordingly and assigns each a stable unique identifier.</p>
</li>
<li>
<p><strong>Postprocess:</strong></p>
<p>A mirror step to <strong>preprocess</strong>: a convenient hook to run QC checks, add derived fields, attach reference-gene annotations, or compute per-chain quality metrics <strong>after</strong> the dataset is ready. You can pass any number of steps which will be executed in a sequential order.</p>
</li>
<li>
<p><strong>Aggregate repertoires #1:</strong></p>
<p>If you already know how to group chains into receptors, perhaps by <code>"Sample"</code> or <code>"Donor"</code> columns from the metadata, you can pass <code>repertoire_schema = c("Sample")</code> to <code><a href="reference/read_repertoires.html">read_repertoires()</a></code>. Otherwise, skip and define repertoires later (common in single-cell workflows where you need cluster labels first).</p>
</li>
<li><p><strong>Write data on disk:</strong></p></li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="st">`</span><span class="at">read_repertoires</span><span class="st">`</span> always persists what it just built<span class="sc">:</span> column<span class="sc">-</span>compressed Parquet parts plus a human<span class="sc">-</span>readable metadata <span class="cf">in</span> JSON. From here on, downstream steps can reopen the dataset instantly without touching the raw AIRR files again.</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li><strong>Aggregate repertoires #2:</strong></li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>Call <span class="st">`</span><span class="at">agg_repertoires()</span><span class="st">`</span> later <span class="cf">if</span> you withheld grouping until additional annotations were available, e.g. donor <span class="sc">+</span> cell cluster.</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="phase-2-transformation">Phase 2: Transformation<a class="anchor" aria-label="anchor" href="#phase-2-transformation"></a>
</h3>
<pre><code>      ┌───────────┐       ┌────────────────────────────┐
      │ ImmunData │       │ AnnData / Seurat / TCRdist │
      └───────────┘       │ seur@meta.data / adata.obs │
            │             └────────────────────────────┘
            │                             │
            ├─────────────────────────────┘
            │
            ▼
   annotate_immundata()    ──── Import external annotations to ImmunData
            │
            ▼
     agg_repertoires()     ──── Aggregate repertoires
            │
            ▼
    filter_immundata()     ──── Filter receptors or repertoires
            │
            ▼
    mutate_immundata()     ──── Create or modify columns, compute statistics
            │
            │     ┌────────────────┐
            ├────►│ save / plot #1 │
            │     └────────────────┘
            ▼
   annotate_immundata()    ──── Annotate ImmunData with the computed statistics
            │
            │     ┌────────────────┐
            ├────►│ save / plot #2 │
            │     └────────────────┘
            │
            ▼
┌────────────────────────┐
│seur@meta.data[:] &lt;- ...│ ──── Export ImmunData annotations
│    adata.obs = ...     │
└────────────────────────┘</code></pre>
<p>Transformation is a loop of annotation → modification and computation → visualisation, always producing a new <code>ImmunData</code> while leaving the parent intact. That immutability is what turns every notebook into a reproducible pipeline.</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Import external annotations to ImmunData:</strong></p>
<p><code><a href="reference/annotate_immundata.html">annotate_immundata()</a></code> (or its thin wrappers <code><a href="reference/annotate_immundata.html">annotate_barcodes()</a></code> / <code><a href="reference/annotate_immundata.html">annotate_receptors()</a></code>) merges labels from Seurat/AnnData/TCRdist/anything that can be expressed as a keyed data frame to the main table, so each chain has a corresponding annotation.</p>
</li>
<li>
<p><strong>Aggregate repertoires:</strong></p>
<p>Now that extra labels are present, you might regroup receptors, for example, by donor × cell-state.</p>
</li>
<li>
<p><strong>Filter receptors or repertoires:</strong></p>
<p><code><a href="reference/filter_immundata.html">filter_immundata()</a></code> accepts tidy-verse predicates on chains, receptors, or repertoires.</p>
</li>
<li>
<p><strong>Create or modify columns, compute statistics:</strong></p>
<p>On this step, you compute statistics per-repertoire or per-receptor, using input receptor features. There are several scenarios depending on what you try to achieve.</p>
<ol style="list-style-type: decimal">
<li><p>use <code>immunarch</code> for the most common analysis functions. The package will automatically annotate both <strong>receptors/barcodes/chains</strong> (!) and <strong>repertoires</strong> (!!) if it is possible;</p></li>
<li><p>simply mutate on the whole dataset using <code>dplyr</code> syntax, like compute edit distance to a specific pattern using <code>mutate_immundata</code>;</p></li>
<li><p>more complex compute that requires a function to apply to values and is probably not supported by <code>duckplyr</code>. See the <a href="#id_-advanced-topics">🧠 Advanced Topics</a> for more details.</p></li>
</ol>
</li>
<li>
<p><strong>Save / plot #1:</strong></p>
<p>Cache the <code>ImmunData</code>. Use <code>ggplot2</code> to visualise the statistics, computed from <code>ImmunData</code>.</p>
</li>
<li>
<p><strong>Annotate ImmunData with the computed statistics:</strong></p>
<p><code><a href="reference/annotate_immundata.html">annotate_immundata()</a></code> (again) joins the freshly minted statistics back to the canonical dataset.</p>
</li>
<li>
<p><strong>Save / plot #2:</strong></p>
<p>Save the <code>ImmunData</code> with new annotations to disk. Plot the results of analysis.</p>
</li>
<li>
<p><strong>Export ImmunData annotations:</strong></p>
<p>Write the annotated data back to the cell-level dataset (Seurat / AnnData) for the subsequent analysis. Additionally, you could write the <code>ImmunData</code> itself to disk if needed.</p>
</li>
</ol>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="id_-ingestion">💾 Ingestion<a class="anchor" aria-label="anchor" href="#id_-ingestion"></a>
</h2>
<div class="section level3">
<h3 id="load-airr-data">Load AIRR data<a class="anchor" aria-label="anchor" href="#load-airr-data"></a>
</h3>
<p><code>immundata</code> provides a flexible system for loading immune receptor repertoire files from different sources – CSV, TSV and Parquet files, possibly gzipped, with some optionality. The main function for this is <code><a href="reference/read_repertoires.html">read_repertoires()</a></code>. Below are four ways to pass your file paths and one for convering data from existing <code>immunarch pre-1.0</code> list objects with <code>$data</code> and <code>$meta</code>.</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Pass a single file name:</strong></p>
<p>If you just have <strong>one</strong> AIRR file:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">inp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"sample_0_1k.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span></span>
<span>  path   <span class="op">=</span> <span class="va">inp_file</span>,</span>
<span>  schema <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3_aa"</span>, <span class="st">"v_call"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Pass a vector of file names:</strong></p>
<p>For <strong>multiple</strong> files in a vector:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">inp_file1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"sample_0_1k.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">inp_file2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"sample_1k_2k.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">file_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">inp_file1</span>, <span class="va">inp_file2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span></span>
<span>  path   <span class="op">=</span> <span class="va">file_vec</span>,</span>
<span>  schema <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3_aa"</span>, <span class="st">"v_call"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
<p><code>immundata</code> automatically merges them (depending on your chosen schema), writes the aggregated data into a single directory of Parquet files, and produces a single-cell <code>ImmunData</code> object. Think about it as a huge table instead of smaller multiple repertoire tables.</p>
</li>
<li>
<p><strong>Pass a glob pattern:</strong></p>
<p>If your files follow a consistent naming pattern, you can leverage shell globs:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">folder_with_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">""</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glob_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">folder_with_files</span>, <span class="st">"sample*.tsv"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">glob_files</span><span class="op">)</span></span>
<span><span class="co"># The output is something like "/Library/Frameworks/.../immundata/extdata/tsv/*"</span></span>
<span><span class="co"># Mind the star "*" at the end</span></span>
<span></span>
<span><span class="co"># For example, all AIRR files in the 'samples/' folder</span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span></span>
<span>  path   <span class="op">=</span> <span class="va">glob_files</span>,</span>
<span>  schema <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3_aa"</span>, <span class="st">"v_call"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
<p>Behind the scenes, <code><a href="reference/read_repertoires.html">read_repertoires()</a></code> expands the glob with <code>Sys.glob(...)</code>, merges the data, and produces a single <code>ImmunData</code>.</p>
</li>
<li>
<p><strong>Use a metadata file:</strong></p>
<p>Sometimes you need more control over the data source (e.g. consistent sample naming, extra columns). In that case:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Load metadata</strong> with <code><a href="reference/read_metadata.html">read_metadata()</a></code>.</p></li>
<li><p><strong>Pass</strong> the resulting data frame to <code>read_repertoires(path = "&lt;metadata&gt;", ..., metadata = md_table)</code>. Mind the <code>"&lt;metadata&gt;"</code> string we pass to the function. It indicates that we should take file paths from the input metadata table.</p></li>
</ol>
<p>An example code:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">md_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"metadata.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">md_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_metadata.html">read_metadata</a></span><span class="op">(</span><span class="va">md_path</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">md_table</span><span class="op">)</span></span></code></pre></div>
<pre><code># The column "File" stores the file paths. If you have a different column name
# for files, use the `metadata_file_col = "&lt;your column name&gt;"` argument.
# A tibble: 2 × 5
  File                       Therapy Response Prefix filename
  &lt;chr&gt;                      &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;
1 /.../immundata-/inst/extd… ICI     FR       S1_    /Users/…
2 /.../immundata-/inst/extd… CAR-T   PR       S2_    /Users/…</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span></span>
<span>  path     <span class="op">=</span> <span class="st">"&lt;metadata&gt;"</span>,</span>
<span>  metadata <span class="op">=</span> <span class="va">md_table</span>,</span>
<span>  schema   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3_aa"</span>, <span class="st">"v_call"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
<p>This approach <strong>unifies</strong> sample-level metadata (e.g. donor ID, timepoint) with your repertoire data inside a single <code>ImmunData</code>.</p>
<p>You can pass the metadata table separately along with the list of files as we did in the previous examples without the “<metadata>” directive, but in that case you would need to check the correctness of all filepaths by yourself. Which could be quite cumbersome, to say the least.</metadata></p>
<p>The more information on how to work with metadata files, please read the next section.</p>
</li>
<li>
<p><strong>Convert from <code>immunarch</code> lists:</strong></p>
<p>Pass <code>immunarch</code> data lists to <code><a href="reference/from_immunarch.html">from_immunarch()</a></code> to create <code>ImmunData</code> objects.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span><span class="co"># Install old immunarch:</span></span>
<span><span class="co"># pak::pkg_install("immunomind/immunarch@0.9.1")</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">immdata</span>, package <span class="op">=</span> <span class="st">"immunarch"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/from_immunarch.html">from_immunarch</a></span><span class="op">(</span></span>
<span>  imm <span class="op">=</span> <span class="va">immdata</span>, </span>
<span>  schema <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CDR3.aa"</span>, <span class="st">"V.name"</span><span class="op">)</span>, </span>
<span>  output_folder <span class="op">=</span> <span class="st">"./immdata-test"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="working-with-metadata-table-files">Working with metadata table files<a class="anchor" aria-label="anchor" href="#working-with-metadata-table-files"></a>
</h3>
<p>Metadata tables store the sample-level information. When <code>immundata</code> loads the metadata, it annotates every receptor from a given sample (or file) with the corresponding metadata fields. For example, if a sample has “Therapy” = “CAR‑T”, all receptors from that sample receive the same “Therapy” value. You can then aggregate receptors by donor, tissue, or any other field and run your analysis on those repertoires (see the next sections for aggregations).</p>
<blockquote>
<p>[!WARNING] In the current version, “metadata” and “repertoire schema” is the same, meaning you can’t get a metadata field to <code>idata$repertoires</code> if you haven’t define repertoires using that field. I will implement it in the next versions; for now, please consider using <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">dplyr::left_join</a></code> to merge metadata and the repertoires table together.</p>
</blockquote>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">md_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"metadata.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">md_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_metadata.html">read_metadata</a></span><span class="op">(</span><span class="va">md_path</span><span class="op">)</span></span></code></pre></div>
<pre><code>Rows: 2 Columns: 4
── Column specification ─────────────────────────────────────────────────────────
Delimiter: "\t"
chr (4): File, Therapy, Response, Prefix

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
ℹ Found 2/2 repertoire files from the metadata on the disk
✔ Metadata parsed successfully</code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">md_table</span><span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 2 × 5
  File                       Therapy Response Prefix filename
  &lt;chr&gt;                      &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;
1 /.../immundata-/inst/extd… ICI     FR       S1_    /Users/…
2 /.../immundata-/inst/extd… CAR-T   PR       S2_    /Users/…</code></pre>
</div>
<div class="section level3">
<h3 id="receptor-schema">Receptor schema<a class="anchor" aria-label="anchor" href="#receptor-schema"></a>
</h3>
<p><code>immundata</code> lets you decide what a receptor means for your study by specifying:</p>
<ul>
<li><p>Feature columns - which fields make a receptor unique. Usually it is <code>"cdr3_aa"</code> and <code>"v_call"</code> columns.</p></li>
<li><p>Chains to keep / pair - e.g. TRA only or a pair TRA + TRB.</p></li>
</ul>
<p>If you have only feature columns, you can usually pass the character vector with columns to functions. In a more advanced case with multiple chain data, <code>immundata</code> provides a helper function <code><a href="reference/make_receptor_schema.html">make_receptor_schema()</a></code> for building schemas:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_receptor_schema.html">make_receptor_schema</a></span><span class="op">(</span></span>
<span>  features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3_aa"</span>, <span class="st">"v_call"</span><span class="op">)</span>,</span>
<span>  chains   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TRA"</span>, <span class="st">"TRB"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>
<p><strong>Chain-agnostic</strong></p>
<p>Used for bulk or pre-filtered immune repertoire data. No filtering by chain data such as TRA or TRB. Each unique combination of features in the schema vector is assigned a unique receptor identifier and counts as a receptor. In the example below, the receptor features are “cdr3_aa” and “v_call” columns - CDR3 amino acid sequence and V gene segment columns respectively.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">inp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/tsv"</span>, <span class="st">"sample_0_1k.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3_aa"</span>, <span class="st">"v_call"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span></span>
<span>  path   <span class="op">=</span> <span class="va">inp_file</span>,</span>
<span>  schema <span class="op">=</span> <span class="va">schema</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Single-chain</strong></p>
<blockquote>
<p>[!NOTE] Please note that single-chain option does not (!) remove multiple chains per cell - yet. In other words, you will get multiple receptors per barcode. The paired chain option filter out chains which don’t have the max number of reads or umis per barcode. So receptor numbers and sequences could differ significantly.</p>
</blockquote>
<p>Used for paired-chain data such as single-cell data to focus on the analysis of immune receptors with a specific chain. The data is pre-filtered to leave the data units with the specified chain only.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">inp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"lt6.csv.gz"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_receptor_schema.html">make_receptor_schema</a></span><span class="op">(</span></span>
<span>  features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3"</span>, <span class="st">"v_call"</span><span class="op">)</span>,</span>
<span>  chains   <span class="op">=</span> <span class="st">"TRA"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span></span>
<span>  path        <span class="op">=</span> <span class="va">inp_file</span>,</span>
<span>  schema      <span class="op">=</span> <span class="va">schema</span>,</span>
<span>  barcode_col <span class="op">=</span> <span class="st">"barcode"</span>,</span>
<span>  locus_col   <span class="op">=</span> <span class="st">"locus"</span>,</span>
<span>  preprocess  <span class="op">=</span> <span class="fu"><a href="reference/preprocess_postprocess.html">make_default_preprocessing</a></span><span class="op">(</span><span class="st">"10x"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Paired-chain</strong></p>
<p>When you want full αβ (or heavy‑light) receptors, immundata can pair two chains that originate from the same barcode and keep, for each locus, the chain with the highest UMI/reads. A single unique receptor identifier is then assigned to the pair. The data is pre-filtered to loci in target chains. Within each barcode×locus the the chain with max umis or reads is selected. Barcodes lacking either chain are dropped from the receptor table.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">inp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"lt6.csv.gz"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_receptor_schema.html">make_receptor_schema</a></span><span class="op">(</span></span>
<span>  features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3"</span>, <span class="st">"v_call"</span><span class="op">)</span>,</span>
<span>  chains   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TRA"</span>, <span class="st">"TRB"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span></span>
<span>  path        <span class="op">=</span> <span class="va">inp_file</span>,</span>
<span>  schema      <span class="op">=</span> <span class="va">schema</span>,</span>
<span>  barcode_col <span class="op">=</span> <span class="st">"barcode"</span>,         <span class="co"># required for pairing</span></span>
<span>  locus_col   <span class="op">=</span> <span class="st">"locus"</span>,           <span class="co"># column that says "TRA" / "TRB"</span></span>
<span>  umi_col     <span class="op">=</span> <span class="st">"umis"</span>,            <span class="co"># choose chain with max UMIs per locus</span></span>
<span>  preprocess  <span class="op">=</span> <span class="fu"><a href="reference/preprocess_postprocess.html">make_default_preprocessing</a></span><span class="op">(</span><span class="st">"10x"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
<p>Cheat-sheet for arguments to <code>read_repertoires</code>:</p>
<table class="table">
<colgroup>
<col width="44%">
<col width="14%">
<col width="12%">
<col width="10%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th>Situation</th>
<th><code>barcode_col</code></th>
<th><code>locus_col</code></th>
<th><code>umi_col</code></th>
<th><code>chains</code></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Bulk data, no locus filtering</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>omit / <code>NULL</code>
</td>
</tr>
<tr class="even">
<td>Analyse TRA only</td>
<td>
<strong>yes</strong>¹</td>
<td><strong>yes</strong></td>
<td>no</td>
<td><code>"TRA"</code></td>
</tr>
<tr class="odd">
<td>Pair TRA+TRB, pick best chain per cell</td>
<td><strong>yes</strong></td>
<td><strong>yes</strong></td>
<td><strong>yes</strong></td>
<td><code>c("TRA","TRB")</code></td>
</tr>
</tbody>
</table>
<p>¹ If you pass barcodes, they’re stored but used for counting only.</p>
</div>
<div class="section level3">
<h3 id="repertoire-schema">Repertoire schema<a class="anchor" aria-label="anchor" href="#repertoire-schema"></a>
</h3>
<p>To compute repertoire‑level statistics such as gene‑segment usage, the Jaccard coefficient, or the incidence of public receptors, you first need to define a repertoire. In <code>immundata</code> a repertoire is simply a group of receptors that share one or more values from annotation columns.</p>
<p>Just like with receptors, you can pass a schema – a character vector of column names – to specify how receptors are grouped into repertoires.</p>
<p>For the bulk data, usually, you rely on the metadata table. It could be useful when you want to aggregate together receptors from the same donor or tissue, and then analyse it. Or you may want to filter out non-responders to analyse the responders only.</p>
<blockquote>
<p>[!NOTE] Don’t confuse grouping of immune repertoires with grouping in plots. When you define an immune repertoire, all the proportions are recomputed, and each receptor assigned a unique repertoire identifier for faster computations. You create virtual “tables” with immune receptors, and you can work with them separately using filters or mutations, despite that the data is still stored as a huge table with all receptors. When you plot data, you first compute statistics per defined immune repertoire, and then you group it. You can later plot or re‑group the resulting statistics, but the order of operations matters.</p>
</blockquote>
<p>The true power of regrouping repertoires opens up when you work with single-cell data.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span>      </span>
<span><span class="va">inp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"lt6.csv.gz"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">md_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"metadata.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">md_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_metadata.html">read_metadata</a></span><span class="op">(</span><span class="va">md_file</span><span class="op">)</span></span>
<span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_receptor_schema.html">make_receptor_schema</a></span><span class="op">(</span>features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3"</span>, <span class="st">"v_call"</span><span class="op">)</span>, chains   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TRA"</span>, <span class="st">"TRB"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span></span>
<span>  path        <span class="op">=</span> <span class="va">inp_file</span>,</span>
<span>  schema      <span class="op">=</span> <span class="va">schema</span>,</span>
<span>  metadata    <span class="op">=</span> <span class="va">md_table</span>,</span>
<span>  barcode_col <span class="op">=</span> <span class="st">"barcode"</span>,         <span class="co"># required for pairing</span></span>
<span>  locus_col   <span class="op">=</span> <span class="st">"locus"</span>,           <span class="co"># column that says "TRA" / "TRB"</span></span>
<span>  umi_col     <span class="op">=</span> <span class="st">"umis"</span>,            <span class="co"># choose chain with max UMIs per locus</span></span>
<span>  preprocess  <span class="op">=</span> <span class="fu"><a href="reference/preprocess_postprocess.html">make_default_preprocessing</a></span><span class="op">(</span><span class="st">"10x"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cells_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"cells.tsv.gz"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">cells_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># External cell annotations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cells</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Annotate data with cell clusters</span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/annotate_immundata.html">annotate_barcodes</a></span><span class="op">(</span></span>
<span>  idata <span class="op">=</span> <span class="va">idata</span>,</span>
<span>  annotations <span class="op">=</span> <span class="va">cells</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cell_id"</span>, <span class="st">"ident"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>  annot_col <span class="op">=</span> <span class="st">"cell_id"</span>, </span>
<span>  keep_repertoires <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Aggregate repertoires to make cluster-specific repertoires</span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="reference/agg_repertoires.html">agg_repertoires</a></span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"ident"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Take a look at the $repertoires table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preprocessing-and-postprocessing-strategies">Preprocessing and postprocessing strategies<a class="anchor" aria-label="anchor" href="#preprocessing-and-postprocessing-strategies"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<ol style="list-style-type: decimal">
<li><em>… in progress …</em></li>
</ol>
<ul>
<li>removing columns (“on” by default)</li>
<li>filtering non productive (“on” by default)</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>
<p><strong>Barcode prefix</strong></p>
<p>Provide a column named “Prefix” to the metadata so <code><a href="reference/preprocess_postprocess.html">make_default_postprocessing()</a></code> can automatically add this prefix to barcodes to make barcodes unique in your resultant dataset.</p>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="managing-the-output-and-intermediate-immundata-files">Managing the output and intermediate ImmunData files<a class="anchor" aria-label="anchor" href="#managing-the-output-and-intermediate-immundata-files"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p>By default, <code><a href="reference/read_repertoires.html">read_repertoires()</a></code> writes the created Parquet files into a directory named <code>immundata_&lt;first filen name&gt;</code>. Consider passing <code>output_folder</code> to <code><a href="reference/read_repertoires.html">read_repertoires()</a></code> if you want to specify the output path.</p>
</div>
<div class="section level3">
<h3 id="writing-immundata-objects-on-disk">Writing ImmunData objects on disk<a class="anchor" aria-label="anchor" href="#writing-immundata-objects-on-disk"></a>
</h3>
<p>Use <code>write_immundata</code> to save ImmunData objects.</p>
<p>Why you might need it - to save intermediate files, e.g., after computing levenshtein distance to specific receptors from the database. In that case, you wouldn’t need to recompute the distances each time.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="id_-immundata-object">🧿 ImmunData Object<a class="anchor" aria-label="anchor" href="#id_-immundata-object"></a>
</h2>
<p><code>ImmunData</code> object is a self-describing container that holds your immune repertoire dataset. <code>ImmunData</code> objects has several slots accessible via <code>&lt;object&gt;$&lt;slot&gt;</code>:</p>
<ul>
<li><p><code>ImmunData$receptors</code> – a virtual table created on demand from <code>$annotations</code>. One row per receptor as defined by your <code>$schema_receptor</code>; guaranteed to have the stable key <code>imd_receptor_id</code>. This is the aggregated view into your dataset, meaning that all fields from receptor features (cdr3, v_call) are unique with respect to row, i.e., each row is unique.</p></li>
<li><p><code>ImmunData$annotations</code> – the main table that holds all the data. One row per chain (or per cell barcode in case of single-chained data). Holds every AIRR field (cdr3, v_call, umis, etc.) plus any metadata you imported (sample_id, tissue, distances to patterns).</p></li>
<li><p><code>ImmunData$repertoires</code> – a physical table produced by agg_repertoires(). Each row is a repertoire (sample, donor, cluster) and carries pre-computed counts: number of receptors, barcodes, chains.</p></li>
<li><p><code>ImmunData$schema_receptor</code> – the recipe that says how to collapse chains into receptors: which features make them identical (e.g. cdr3_aa, v_call) and which loci must pair (e.g. α+β, heavy+light, single-chain).</p></li>
<li><p><code>ImmunData$schema_repertoire</code> – the grouping keys used to bundle receptors into repertoires (e.g. sample_id, donor_id, time_point, etc.). Lets you define multiple biological layers inside one dataset (e.g. patient level vs. patient × cluster level) and switch between them.</p></li>
</ul>
<p>You should not and you can not change those slots directly. Being a self-describing container is a harsh life, full of dangers and unwanted adventures, and it requires a constant re-evaluation of what goes there and why. <code>immundata</code> functions do that internally.</p>
<p>Every transformation returns a new <code>ImmunData</code>, so you can stash (not trash) intermediate versions on disk and reproduce any branch of the analysis.</p>
<p>Example:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span>      </span>
<span><span class="va">inp_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">""</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span>, <span class="st">"/*.csv.gz"</span><span class="op">)</span></span>
<span><span class="va">md_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"metadata.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">md_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_metadata.html">read_metadata</a></span><span class="op">(</span><span class="va">md_file</span><span class="op">)</span></span>
<span><span class="va">cells_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"cells.tsv.gz"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">cells_file</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_receptor_schema.html">make_receptor_schema</a></span><span class="op">(</span>features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3"</span>, <span class="st">"v_call"</span><span class="op">)</span>, chains <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TRB"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">inp_files</span>, schema <span class="op">=</span> <span class="va">schema</span>, metadata <span class="op">=</span> <span class="va">md_table</span>, barcode_col <span class="op">=</span> <span class="st">"barcode"</span>, locus_col <span class="op">=</span> <span class="st">"locus"</span>, umi_col <span class="op">=</span> <span class="st">"umis"</span>, preprocess <span class="op">=</span> <span class="fu"><a href="reference/preprocess_postprocess.html">make_default_preprocessing</a></span><span class="op">(</span><span class="st">"10x"</span><span class="op">)</span>, repertoire_schema <span class="op">=</span> <span class="st">"Tissue"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span></span></code></pre></div>
<p>Printed ImmunData <code>idata</code>:</p>
<pre><code>── ImmunData ───────────────────────────────────────────────────────────────────────────────────────────

── Receptors: ──

# A duckplyr data frame: 3 variables
   imd_receptor_id cdr3               v_call
             &lt;int&gt; &lt;chr&gt;              &lt;chr&gt;
 1            2514 CASSVHPQYF         TRBV2
 2            7687 CAWSGQGWGGSTDTQYF  TRBV30
 3            2515 CASSPRPGSTGELFF    TRBV18
 4            5111 CASSQGLGVSYEQYF    TRBV4-1
 5            7688 CASSHGQGRTGELFF    TRBV7-2
 6            7689 CASGLRRGRDSGANVLTF TRBV19
 7            2516 CSAHRGLGNQPQHF     TRBV20-1
 8            5112 CASSPQGVSNQPQHF    TRBV7-2
 9               1 CASSSVSGNSPLHF     TRBV7-9
10            5113 CASPLGALTDTQYF     TRBV2
# ℹ more rows
# ℹ Use `print(n = ...)` to see more rows

── Annotations: ──

# A duckplyr data frame: 23 variables
   barcode   locus v_call d_call j_call c_gene productive cdr3  cdr3_nt reads  umis filename imd_barcode
   &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;
 1 AAACCTGA… TRB   TRBV2  None   TRBJ2… TRBC2  True       CASS… TGTGCC… 13736    11 /Users/… LB6_AAACCT…
 2 AAACCTGC… TRB   TRBV30 TRBD1  TRBJ2… TRBC2  True       CAWS… TGTGCC…  4062     5 /Users/… LB6_AAACCT…
 3 AAACCTGC… TRB   TRBV18 TRBD2  TRBJ2… TRBC2  True       CASS… TGTGCC…  8617    10 /Users/… LB6_AAACCT…
 4 AAACCTGG… TRB   TRBV4… TRBD1  TRBJ2… TRBC2  True       CASS… TGCGCC…  6811     5 /Users/… LB6_AAACCT…
 5 AAACCTGG… TRB   TRBV7… TRBD1  TRBJ2… TRBC2  True       CASS… TGTGCC… 16836    15 /Users/… LB6_AAACCT…
 6 AAACCTGT… TRB   TRBV19 TRBD2  TRBJ2… TRBC2  True       CASG… TGTGCC…  8805     9 /Users/… LB6_AAACCT…
 7 AAACCTGT… TRB   TRBV2… TRBD1  TRBJ1… TRBC1  True       CSAH… TGCAGT…  8311     6 /Users/… LB6_AAACCT…
 8 AAACGGGA… TRB   TRBV7… TRBD1  TRBJ1… TRBC1  True       CASS… TGTGCC…  3390     3 /Users/… LB6_AAACGG…
 9 AAACGGGA… TRB   TRBV7… TRBD2  TRBJ1… TRBC1  True       CASS… TGTGCC…  4956     4 /Users/… LB6_AAACGG…
10 AAACGGGA… TRB   TRBV2  TRBD1  TRBJ2… TRBC2  True       CASP… TGTGCC…  5625     4 /Users/… LB6_AAACGG…
# ℹ more rows
# ℹ 10 more variables: imd_chain_id &lt;int&gt;, imd_receptor_id &lt;int&gt;, imd_n_chains &lt;dbl&gt;, File &lt;chr&gt;,
#   Tissue &lt;chr&gt;, Prefix &lt;chr&gt;, imd_count &lt;dbl&gt;, imd_repertoire_id &lt;int&gt;, imd_proportion &lt;dbl&gt;,
#   n_repertoires &lt;int&gt;
# ℹ Use `print(n = ...)` to see more rows

── Receptor schema: ──

features:
→ cdr3
→ v_call
chains:
→ TRB


── Repertoire schema: ──

→ Tissue


── List of repertoires: ──

# A tibble: 3 × 4
  imd_repertoire_id Tissue n_barcodes n_receptors
              &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;       &lt;int&gt;
1                 1 Blood        4085        3976
2                 2 Normal       6797        2950
3                 3 Tumor        7832        3962</code></pre>
<hr>
</div>
<div class="section level2">
<h2 id="id_-transformation">🛠 Transformation<a class="anchor" aria-label="anchor" href="#id_-transformation"></a>
</h2>
<p>Before running the code in the following subsections, execute the code below. Mind that for the example purposes, the data uses the TRB locus only. Change the input receptor schema and the column names to adapt it to the paired-chain case.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunomind.com/" class="external-link">immundata</a></span><span class="op">)</span></span>
<span>      </span>
<span><span class="va">inp_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">""</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span>, <span class="st">"/*.csv.gz"</span><span class="op">)</span></span>
<span><span class="va">md_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"metadata.tsv"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">md_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_metadata.html">read_metadata</a></span><span class="op">(</span><span class="va">md_file</span><span class="op">)</span></span>
<span><span class="va">cells_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/single_cell"</span>, <span class="st">"cells.tsv.gz"</span>, package <span class="op">=</span> <span class="st">"immundata"</span><span class="op">)</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">cells_file</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_receptor_schema.html">make_receptor_schema</a></span><span class="op">(</span>features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cdr3"</span>, <span class="st">"v_call"</span><span class="op">)</span>, chains <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TRB"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_repertoires.html">read_repertoires</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">inp_files</span>, schema <span class="op">=</span> <span class="va">schema</span>, metadata <span class="op">=</span> <span class="va">md_table</span>, barcode_col <span class="op">=</span> <span class="st">"barcode"</span>, locus_col <span class="op">=</span> <span class="st">"locus"</span>, umi_col <span class="op">=</span> <span class="st">"umis"</span>, preprocess <span class="op">=</span> <span class="fu"><a href="reference/preprocess_postprocess.html">make_default_preprocessing</a></span><span class="op">(</span><span class="st">"10x"</span><span class="op">)</span>, repertoire_schema <span class="op">=</span> <span class="st">"Tissue"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="filter">Filter<a class="anchor" aria-label="anchor" href="#filter"></a>
</h3>
<p>The key functions for filtering are <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code> (<code>dplyr</code>-compatible) and <code><a href="reference/filter_immundata.html">filter_immundata()</a></code>, which are the same function with a slightly different arguments due to the necessity to comply with <code>dplyr</code> interface. Repertoires are reaggregated automatically. Functions <code><a href="reference/filter_immundata.html">filter_receptors()</a></code> and <code><a href="reference/filter_immundata.html">filter_barcodes()</a></code> are used for filter receptor and barcode identifiers, correspondingly.</p>
<p>To filter data, you simply pass predicates like in <code>dplyr</code>. Optionally, you can pass <code>seq_options</code> that allow you to filter by exact sequence match, regex pattern, or sequence distances using hamming or edit/levenshtein distances. You can pass multiple patterns via <code>patterns = c("pattern_1", "pattern_2")</code>.</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Filter by any annotation</strong></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">v_call</span> <span class="op">==</span> <span class="st">"TRBV2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Tissue</span> <span class="op">==</span> <span class="st">"Blood"</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Chain filters together</strong></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># this expression:</span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">v_call</span> <span class="op">==</span> <span class="st">"TRBV2"</span>, <span class="va">imd_proportion</span> <span class="op">&gt;=</span> <span class="fl">0.0002</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># is the same as this one:</span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">v_call</span> <span class="op">==</span> <span class="st">"TRBV2"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imd_proportion</span> <span class="op">&gt;=</span> <span class="fl">0.0002</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Filter by sequence distance</strong></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span>seq_options <span class="op">=</span> <span class="fu"><a href="reference/make_seq_options.html">make_seq_options</a></span><span class="op">(</span>patterns <span class="op">=</span> <span class="st">"CASSELAGYRGEQYF"</span>, query_col <span class="op">=</span> <span class="st">"cdr3"</span>, method <span class="op">=</span> <span class="st">"lev"</span>, max_dist <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">v_call</span> <span class="op">==</span> <span class="st">"TRBV2"</span>, seq_options <span class="op">=</span> <span class="fu"><a href="reference/make_seq_options.html">make_seq_options</a></span><span class="op">(</span>patterns <span class="op">=</span> <span class="st">"CASSELAGYRGEQYF"</span>, query_col <span class="op">=</span> <span class="st">"cdr3"</span>, method <span class="op">=</span> <span class="st">"lev"</span>, max_dist <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Filter by receptor identifiers</strong></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="reference/filter_immundata.html">filter_receptors</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Filter by barcodes</strong></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_bc</span> <span class="op">&lt;-</span> <span class="va">cells</span><span class="op">$</span><span class="va">cell_id</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="reference/filter_immundata.html">filter_barcodes</a></span><span class="op">(</span><span class="va">target_bc</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Filter by repertoire</strong></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imd_repertoire_id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Tissue</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Blood"</span>, <span class="st">"Tumor"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="annotate">Annotate<a class="anchor" aria-label="anchor" href="#annotate"></a>
</h3>
<p>The key function for annotations are <code>annotate</code> and <code>annotate_immundata</code>. Functions <code><a href="reference/annotate_immundata.html">annotate_receptors()</a></code>, <code><a href="reference/annotate_immundata.html">annotate_barcodes()</a></code> and <code><a href="reference/annotate_immundata.html">annotate_chains()</a></code> are light-weight wrappers around <code><a href="reference/annotate_immundata.html">annotate_immundata()</a></code>.</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Annotate by any column</strong></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/annotate_immundata.html">annotate</a></span><span class="op">(</span>idata <span class="op">=</span> <span class="va">idata</span>, annotations <span class="op">=</span> <span class="va">cells</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cell_id"</span>, <span class="st">"ident"</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>imd_barcode <span class="op">=</span> <span class="st">"cell_id"</span><span class="op">)</span>, keep_repertoires <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">idata2</span> <span class="op">&lt;-</span> <span class="va">idata2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ident</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">idata2</span> <span class="op">&lt;-</span> <span class="va">idata2</span> <span class="op">|&gt;</span> <span class="fu"><a href="reference/agg_repertoires.html">agg_repertoires</a></span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"ident"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata2</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Annotate by receptor identifiers</strong></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/annotate_immundata.html">annotate_receptors</a></span><span class="op">(</span>idata <span class="op">=</span> <span class="va">idata</span>, annotations <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>receptor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>, important_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span><span class="op">)</span>, annot_col <span class="op">=</span> <span class="st">"receptor"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">important_data</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Annotate by barcodes</strong></p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/annotate_immundata.html">annotate_barcodes</a></span><span class="op">(</span>idata <span class="op">=</span> <span class="va">idata</span>, annotations <span class="op">=</span> <span class="va">cells</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cell_id"</span>, <span class="st">"ident"</span><span class="op">)</span><span class="op">]</span>,  annot_col <span class="op">=</span> <span class="st">"cell_id"</span>, keep_repertoires <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">idata2</span> <span class="op">&lt;-</span> <span class="va">idata2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ident</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">idata2</span> <span class="op">&lt;-</span> <span class="va">idata2</span> <span class="op">|&gt;</span> <span class="fu"><a href="reference/agg_repertoires.html">agg_repertoires</a></span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"ident"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">idata2</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="modify">Modify<a class="anchor" aria-label="anchor" href="#modify"></a>
</h3>
<p>The key functions for this are <code>mutate</code> (<code>dplyr</code>-compatible) / <code>mutate_immundata</code> and the functions from the downstream analysis tools.</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Add or transform one or several annotation columns</strong></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>new_column <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>big_chains <span class="op">=</span> <span class="va">umis</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># You can use duckdb functions via `dd$&lt;function&gt;`</span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dist_to_pattern <span class="op">=</span> <span class="va">dd</span><span class="op">$</span><span class="fu">levenshtein</span><span class="op">(</span><span class="va">cdr3</span>, <span class="st">"CASSSVSGNSPLHF"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Add columns with sequence distance to patterns</strong></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CASSVHPQYF"</span>, <span class="st">"CAWSGQGWGGSTDTQYF"</span>, <span class="st">"CASSPRPGSTGELFF"</span><span class="op">)</span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>seq_options <span class="op">=</span> <span class="fu"><a href="reference/make_seq_options.html">make_seq_options</a></span><span class="op">(</span>query_col <span class="op">=</span> <span class="st">"cdr3"</span>, patterns <span class="op">=</span> <span class="va">patterns</span>, method <span class="op">=</span> <span class="st">"lev"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>seq_options <span class="op">=</span> <span class="fu"><a href="reference/make_seq_options.html">make_seq_options</a></span><span class="op">(</span>query_col <span class="op">=</span> <span class="st">"cdr3"</span>, patterns <span class="op">=</span> <span class="va">patterns</span>, method <span class="op">=</span> <span class="st">"lev"</span>, name_type <span class="op">=</span> <span class="st">"pattern"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Modify a subset of column values</strong></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>found_pattern <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">cdr3</span> <span class="op">==</span> <span class="st">"CASSVHPQYF"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<hr>
</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="id_-analysis">📈 Analysis<a class="anchor" aria-label="anchor" href="#id_-analysis"></a>
</h2>
<div class="section level3">
<h3 id="basic-analysis-using-immundata">Basic analysis using <code>immundata</code>
<a class="anchor" aria-label="anchor" href="#basic-analysis-using-immundata"></a>
</h3>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Find receptors from several repertoires which have &gt;60 abundance</span></span>
<span><span class="co"># and get their barcodes</span></span>
<span><span class="va">idata2</span> <span class="op">&lt;-</span> <span class="va">idata</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imd_count</span> <span class="op">&gt;=</span> <span class="fl">60</span><span class="op">)</span></span>
<span><span class="va">target_chains</span> <span class="op">&lt;-</span> <span class="va">idata2</span><span class="op">$</span><span class="va">annotations</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">imd_barcode</span>, <span class="va">imd_count</span>, <span class="va">cdr3</span>, <span class="va">v_call</span>, <span class="va">Tissue</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">target_chains</span></span>
<span></span>
<span><span class="co"># You can then annotate those receptors in your single-cell data using</span></span>
<span><span class="co"># the `imd_barcode` column as a key.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="advanced-analysis-using-immundata">Advanced analysis using <code>immundata</code>
<a class="anchor" aria-label="anchor" href="#advanced-analysis-using-immundata"></a>
</h3>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install the latest pre-1.0 version of immunarch</span></span>
<span><span class="co"># pak::pkg_install(immunomind/immunarch)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://immunarch.com/" class="external-link">immunarch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ov_heatmap</span> <span class="op">&lt;-</span> <span class="fu">airr_public_index</span><span class="op">(</span><span class="va">idata</span>, <span class="st">"jaccard"</span><span class="op">)</span></span>
<span><span class="fu">pheatmap</span><span class="fu">::</span><span class="fu">pheatmap</span><span class="op">(</span><span class="va">ov_heatmap</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clonal_space_homeo</span> <span class="op">&lt;-</span> <span class="fu">airr_clonality</span><span class="op">(</span><span class="va">idata</span>, <span class="st">"prop"</span><span class="op">)</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clonal_space_homeo</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Tissue</span>, y <span class="op">=</span> <span class="va">occupied_prop</span>, fill <span class="op">=</span> <span class="va">clonal_prop_bin</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="id_-use-cases">🧩 Use Cases<a class="anchor" aria-label="anchor" href="#id_-use-cases"></a>
</h2>
<blockquote>
<p>[!TIP] Tutorial on <code>immundata</code> + <code>immunarch</code> is available <a href="">on <code>immunarch</code> website</a>.</p>
<p>Read the previous section about the analysis.</p>
<p>This section is still under construction.</p>
</blockquote>
<div class="section level3">
<h3 id="bulk--repseq-airrseq">Bulk – RepSeq, AIRRSeq<a class="anchor" aria-label="anchor" href="#bulk--repseq-airrseq"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p>Pretty much the whole README is either about single-chain or paired-chain data.</p>
<p>Consider passing <code>make_default_preprocessing("airr")</code> or <code>make_default_preprocessing("10x")</code> to <code>read_repertoires(..., preproc = &lt;here&gt;, ...)</code> to have convenient processing of the corresponding formats.</p>
<p>Pass <code>count_col</code> to <code>read_repertoires(..., count_col = "Counts", ...)</code> to assign counts to chains.</p>
</div>
<div class="section level3">
<h3 id="single-cell-and-paired-chain--scrnaseq-scvdjseq-sctcrseq-scbcrseq">Single-cell and paired-chain – scRNAseq, scVDJseq, scTCRseq, scBCRseq<a class="anchor" aria-label="anchor" href="#single-cell-and-paired-chain--scrnaseq-scvdjseq-sctcrseq-scbcrseq"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p>Make sure to pass <code>make_default_preprocessing("10x")</code>, <code>locus_col</code> and <code>barcode_col</code> to read paired-chain data. Drop the <code>locus_col</code> if you want to read single-chain data only.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span> </span>
<span></span>
<span><span class="va">sdata</span> <span class="op">&lt;-</span> <span class="va">...</span>  <span class="co"># Load the Seurat data</span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="va">...</span>  <span class="co"># Load the corresponding AIRR data</span></span>
<span></span>
<span><span class="co"># Get both GEX and metadata</span></span>
<span><span class="va">smeta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  barcode      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sdata</span><span class="op">)</span>,</span>
<span>  cluster      <span class="op">=</span> <span class="fu">Idents</span><span class="op">(</span><span class="va">sdata</span><span class="op">)</span>,</span>
<span>  gene_MS4A1   <span class="op">=</span> <span class="fu">FetchData</span><span class="op">(</span><span class="va">sdata</span>, <span class="st">"MS4A1"</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/annotate_immundata.html">annotate_barcodes</a></span><span class="op">(</span><span class="va">idata</span>, <span class="va">smeta</span>, annot_col <span class="op">=</span> <span class="st">"barcode"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">AnnDataR</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adata</span> <span class="op">&lt;-</span> <span class="va">...</span>  <span class="co"># Load the AnndataR data</span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="va">...</span>  <span class="co"># Load the corresponding AIRR data</span></span>
<span></span>
<span><span class="va">ameta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  barcode  <span class="op">=</span> <span class="va">adata</span><span class="op">$</span><span class="va">obs_names</span>,</span>
<span>  cluster  <span class="op">=</span> <span class="va">adata</span><span class="op">$</span><span class="va">obs</span><span class="op">$</span><span class="va">cell_type</span>,</span>
<span>  gene_GCG <span class="op">=</span> <span class="va">adata</span><span class="op">$</span><span class="va">X</span><span class="op">[</span>, <span class="st">"GCG"</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/annotate_immundata.html">annotate_barcodes</a></span><span class="op">(</span><span class="va">idata</span>, <span class="va">ameta</span>, annot_col <span class="op">=</span> <span class="st">"barcode"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="spatial--spatial-transcriptomics-and-cell-coordinates">Spatial – spatial transcriptomics and cell coordinates<a class="anchor" aria-label="anchor" href="#spatial--spatial-transcriptomics-and-cell-coordinates"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="annotate-immune-receptors-using-external-airr-databases">Annotate immune receptors using external AIRR databases<a class="anchor" aria-label="anchor" href="#annotate-immune-receptors-using-external-airr-databases"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p><code><a href="reference/annotate_immundata.html">annotate()</a></code></p>
</div>
<div class="section level3">
<h3 id="immunogenicity--run-external-tools-such-as-tcrdist-to-annotate-immundata">Immunogenicity – run external tools such as TCRdist to annotate ImmunData<a class="anchor" aria-label="anchor" href="#immunogenicity--run-external-tools-such-as-tcrdist-to-annotate-immundata"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p>TCRdist: <a href="https://github.com/kmayerb/tcrdist3" class="external-link uri">https://github.com/kmayerb/tcrdist3</a></p>
<p>Save receptors to file and read it via TCRdist. If you need to rename columns, use <code>dplyr</code>.</p>
<pre><code><span><span class="va">receptors_mater</span> <span class="op">&lt;-</span> <span class="va">idata</span><span class="op">$</span><span class="va">receptors</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>cdr3_b_aa <span class="op">=</span> <span class="va">cdr3</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">receptors_mater</span>, <span class="st">"receptors.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read it via TCRdist</span></span>
<span><span class="co"># Run TCRdist and get neighbours</span></span>
<span><span class="co"># Write neightbours to disk</span></span>
<span><span class="co"># Read neighbours to R and annotate `idata` using `annotate()`</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="hybrid-datasets">Hybrid datasets<a class="anchor" aria-label="anchor" href="#hybrid-datasets"></a>
</h3>
<div class="section level4">
<h4 id="multi-locus-data">Multi-locus data<a class="anchor" aria-label="anchor" href="#multi-locus-data"></a>
</h4>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
</div>
<div class="section level4">
<h4 id="multiple-contigs-for-tcr">Multiple contigs for TCR<a class="anchor" aria-label="anchor" href="#multiple-contigs-for-tcr"></a>
</h4>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
</div>
<div class="section level4">
<h4 id="bcr-heavy-chains-with-multiple-light-chains">BCR-heavy chains with multiple light chains<a class="anchor" aria-label="anchor" href="#bcr-heavy-chains-with-multiple-light-chains"></a>
</h4>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
</div>
<div class="section level4">
<h4 id="bulk-and-single-cell-data-integration">Bulk and single-cell data integration<a class="anchor" aria-label="anchor" href="#bulk-and-single-cell-data-integration"></a>
</h4>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p>Artificial barcodes for bulk data</p>
</div>
</div>
<div class="section level3">
<h3 id="receptor-clusters-and-motifs">Receptor clusters and motifs<a class="anchor" aria-label="anchor" href="#receptor-clusters-and-motifs"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p>Run external clustering, assign identifiers to resultant clusters, annotate the data, create new receptors using the assigned identifiers. More convenient alternative to identifiers - cluster motifs.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="id_-advanced-topics">🧠 Advanced Topics<a class="anchor" aria-label="anchor" href="#id_-advanced-topics"></a>
</h2>
<div class="section level3">
<h3 id="developers">Developers<a class="anchor" aria-label="anchor" href="#developers"></a>
</h3>
<div class="section level4">
<h4 id="integrate-into-your-package">Integrate into your package<a class="anchor" aria-label="anchor" href="#integrate-into-your-package"></a>
</h4>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p><code>immundata</code> is created in mind with the mission of replacing typical data frame-based formats, usually not following the AIRR-C file standard.</p>
</div>
<div class="section level4">
<h4 id="extend-with-functions">Extend with functions<a class="anchor" aria-label="anchor" href="#extend-with-functions"></a>
</h4>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<p>S3 methods etc.</p>
</div>
</div>
<div class="section level3">
<h3 id="how-immundata-reads-the-data">How <code>immundata</code> reads the data<a class="anchor" aria-label="anchor" href="#how-immundata-reads-the-data"></a>
</h3>
<p>By design, <strong><code>immundata</code></strong> data-loading pipeline is <strong>three</strong> steps, rather than one giant function. This promotes modularity, easier debugging, and flexible usage:</p>
<ol style="list-style-type: decimal">
<li>
<strong>(Optionally) Load the metadata</strong> via <code><a href="reference/read_metadata.html">read_metadata()</a></code>.
<ul>
<li>This ensures your metadata has the correct file paths, absolute or relative.</li>
</ul>
</li>
<li>
<strong>Load the repertoire files</strong> from disk via <code><a href="reference/read_repertoires.html">read_repertoires()</a></code>.
<ul>
<li>This function unifies your data (be it 1 file or 100 files) and <strong>outputs</strong> a Parquet file:
<ul>
<li>
<strong><code>annotations.parquet</code></strong> (cell-level data, sample metadata, etc.)</li>
</ul>
</li>
<li>It then calls <code><a href="reference/read_immundata.html">read_immundata()</a></code> to return a fully instantiated <code>ImmunData</code> object that uses the newly created files on the disk as a source. The helps two-fold: you don’t lose your data, and it allows <code>immundata</code> to run an optimized code when necessary.</li>
</ul>
</li>
<li>
<strong>(Optionally) Load the same <code>ImmunData</code> files later</strong> with <code><a href="reference/read_immundata.html">read_immundata()</a></code>.
<ul>
<li>If you need to reopen the data in a future R session, you don’t have to redo the entire pipeline.</li>
<li>Just call <code>read_immundata(path_to_immundata_folder)</code> where the folder contains <code>annotations.parquet</code>.</li>
<li>With this approach, you <strong>never</strong> need to re-parse your raw AIRR files once you’ve generated the Parquet-based <code>immundata</code> format.</li>
</ul>
</li>
</ol>
<p>Why split it up?</p>
<ul>
<li>
<strong>Modularity</strong>: If something breaks, you can debug whether it’s in metadata parsing or the actual repertoire table creation.</li>
<li>
<strong>Reusability</strong>: It is straightforward to share one folder with two <code>immundata</code> files.</li>
<li>
<strong>Performance</strong>: Once your data is in <code>immundata</code> format, you can load it in future sessions in <strong>constant time</strong> without merging or parsing again.</li>
</ul>
</div>
<div class="section level3">
<h3 id="custom-functions-for-analysis">Custom functions for analysis<a class="anchor" aria-label="anchor" href="#custom-functions-for-analysis"></a>
</h3>
<blockquote>
<p>[!CAUTION] 🚧 Under construction. 🚧</p>
</blockquote>
<ol style="list-style-type: decimal">
<li><p>Function is supported by <code>duckdb</code> - then use <code>dd$&lt;function_name&gt;</code></p></li>
<li><p>Use SQL</p></li>
<li><p>Run a completely custom function</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="change-ram-limits-to-accelerate-the-backend-computations">Change RAM limits to accelerate the backend computations<a class="anchor" aria-label="anchor" href="#change-ram-limits-to-accelerate-the-backend-computations"></a>
</h3>
<p>You can change the <a href="https://duckplyr.tidyverse.org/articles/large.html#memory-usage" class="external-link">RAM limits in duckplyr</a>.</p>
</div>
<div class="section level3">
<h3 id="make-immundata-even-faster-with-data-engineering-tricks">Make <code>immundata</code> even faster with data engineering tricks<a class="anchor" aria-label="anchor" href="#make-immundata-even-faster-with-data-engineering-tricks"></a>
</h3>
<p>You can use <a href="https://duckdb.org/docs/stable/data/partitioning/hive_partitioning.html" class="external-link">hive partitioning</a> to accelerate analysis. Recommended columns are locus, V gene segment, and sequence length.</p>
</div>
<div class="section level3">
<h3 id="save-your-intermediate-data-for-faster-computations-and-reproducibility">Save your intermediate data for faster computations and reproducibility<a class="anchor" aria-label="anchor" href="#save-your-intermediate-data-for-faster-computations-and-reproducibility"></a>
</h3>
<p>Consider caching your data to disk after heavy operations, such as distance computations.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="id_-about">🏷 About<a class="anchor" aria-label="anchor" href="#id_-about"></a>
</h2>
<div class="section level3">
<h3 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h3>
<p><em>… coming soon …</em></p>
</div>
<div class="section level3">
<h3 id="license">License<a class="anchor" aria-label="anchor" href="#license"></a>
</h3>
<p><a href="https://www.tldrlegal.com/license/apache-license-2-0-apache-2-0" class="external-link">Apache-2.0</a></p>
</div>
<div class="section level3">
<h3 id="author-and-contributors">Author and contributors<a class="anchor" aria-label="anchor" href="#author-and-contributors"></a>
</h3>
<p><strong>Vadim I. Nazarov – main author and developer</strong></p>
<p>Vasily Tsvetkov</p>
<p><em>… more to come …</em></p>
</div>
<div class="section level3">
<h3 id="commercial-usage">Commercial usage<a class="anchor" aria-label="anchor" href="#commercial-usage"></a>
</h3>
<p><code>immundata</code> is free to use for commercial usage as per Apache-2.0 license. However, corporate users will not get a prioritized support for <code>immundata</code>- or AIRR-related issues. The priority of open-source tool <code>immundata</code> is open-source science.</p>
<p>If you are looking for prioritized support and setting up your data pipelines, consider contacting <a href="https://www.linkedin.com/in/vdnaz/" class="external-link">Vadim Nazarov</a> for commercial consulting / support options / workshops and training sessions / designing data platforms and machine learning systems for multi-omics / or anything related.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="id_-faq">🤔 FAQ<a class="anchor" aria-label="anchor" href="#id_-faq"></a>
</h2>
<ol style="list-style-type: decimal">
<li>
<p><strong>Q: Why all the function names or ImmunData fields are so long? I want to write <code>idata$rec</code> instead of <code>idata$receptors</code>.</strong></p>
<p>A: Two major reasons – improving the code readability and motivation to leverage the autocomplete tools. Please consider using <code>tab</code> for leveraging autocomplete. It accelerates things x10-20.</p>
</li>
<li>
<p><strong>Q: How does <code>immundata</code> works under the hood, in simpler terms?</strong></p>
<p>A: Picture a three-layer sandwich:</p>
<ul>
<li><p><code>Arrow</code> files on disk hold the raw tables in column-compressed Parquet.</p></li>
<li><p><code>DuckDB</code> is an in-process SQL engine that can query those files without loading them fully into RAM.</p></li>
<li><p><code>duckplyr</code> glues <code>dplyr</code> verbs (filter, mutate, summarise, …) to DuckDB SQL, so your R code looks exactly like a tidyverse pipeline while the heavy lifting happens in C++.</p></li>
</ul>
<p>When you call <code><a href="reference/read_repertoires.html">read_repertoires()</a></code>, immundata writes <code>Arrow</code> parts, registers them with <code>DuckDB</code>, and returns a <code>duckplyr</code> table. Every later verb is lazily translated into SQL; nothing is materialised until a step truly needs physical data (e.g. a plot or an algorithm that exists only in R).</p>
<p>References</p>
<ol style="list-style-type: decimal">
<li><a href="https://arrow.apache.org/docs/r/" class="external-link">Arrow for R – columnar file format</a></li>
<li><a href="https://duckdb.org/" class="external-link">DuckDB – embedded analytical database</a></li>
<li><a href="https://duckplyr.tidyverse.org/index.html" class="external-link">duckplyr – API/implementation details</a></li>
</ol>
</li>
<li>
<p><strong>Q: Why do you need to create Parquet files with receptors and annotations?</strong></p>
<p>A: Those are intermediate files, optimized for future data operations, and working with them significantly accelerates <code>immundata</code>. I will post a benchmark soon.</p>
</li>
<li>
<p><strong>Q: Why does <code>immundata</code> support only the AIRR standard?!</strong></p>
<p>A: The short answer is because a single, stable schema beats a zoo of drifting ones.</p>
<p>The practical answer is that <code>immundata</code> allows some optionality – you can provide column names for barcodes, etc.</p>
<p>The long answer is that the amount of investments required not only for the development, but also for the continued support of parsers for different formats, is astonishing. I developed parsers for 10+ formats for <code>tcR</code> / <code>immunarch</code> packages. I would much prefer for upstream tool developers not to change their format each minor version, breaking pretty much all downstream pipelines and causing all sorts of pain to end users and tools developers – mind you, without bearing a responsibility to at least notify, but ideally fix the broken formats they introduced. The time of the Wild West is over. The AIRR community did an outstanding job creating its standard. Please urge the creators of your favourite tools or fellow developers to use this format or a superset, like <code>immundata</code> does.</p>
<p><code>immundata</code> does not and will not explicitly support other formats. This is both a practical stance and communication of crucial values, put into <code>immundata</code> as part of a broader ecosystem of AIRR tools. The domain is already too complex, and we need to work together to make this complexity manageable. A healthy ecosystem is not the same as a complex ecosystem.</p>
</li>
<li>
<p><strong>Q: Why is it so complex? Why do we need to use <code>dplyr</code> instead of plain R?</strong></p>
<p>A: The short answer is:</p>
<ul>
<li>faster computations;</li>
<li>code, that is easy to maintain and support by other humans;</li>
<li>better data skills thanks to thinking in immutable transformations,</li>
<li>in most cases you don’t really need complex transformations, so we can optimize 95% of all AIRR data operations behind the scenes.</li>
</ul>
</li>
<li>
<p><strong>Q: How do I use <code>dplyr</code> operations that <code>duckplyr</code> doesn’t support yet?</strong></p>
<p>A: Let’s consider several use cases.</p>
<p><strong>Case 0.</strong> You are missing <code>group_by</code> from <code>dplyr</code>. Use <code>summarise(.by = ???, ...)</code>.</p>
<p><strong>Case 1.</strong> Your data can fit into RAM. Call <code>collect</code> and use <code>dplyr</code>.</p>
<p><strong>Case 2.</strong> Your data won’t fit into RAM but you must run a heavy operation on all rows. You can rewrite functions in SQL. You can break it into supported pieces (e.g. pre-filter, pre-aggregate) that DuckDB can stream, write an intermediate Parquet with <code><a href="https://duckplyr.tidyverse.org/reference/compute_parquet.html" class="external-link">compute_parquet()</a></code>, then loop over chunks, collect them, and run the analysis.</p>
<p><strong>Case 3.</strong> Your data won’t fit into RAM, but before running intensive computations, you are open to working with smaller dataset first. Filter down via <code>slice_head(n=...)</code>, iterate until the code works, then run the same pipeline on the full dataset.</p>
</li>
<li>
<p><strong>Q: You filter out non-productive receptors. How do I explore them?</strong></p>
<p>A: Do not filter out non-productive receptors in <code>preprocess</code> in <code><a href="reference/read_repertoires.html">read_repertoires()</a></code>.</p>
</li>
<li>
<p><strong>Q: Why does <code>immundata</code> have its own column names for receptors and repertoires? Could you just use the AIRR format - repertoire_id etc.?</strong></p>
<p>A: The power of <code>immundata</code> lies in the fast re-aggregation of the data, that allows to work with whatever you define as a repertoire on the fly via <code>agg_repertoires</code>. Hence I use a superset of the AIRR format, which is totally acceptable as per their documentation.</p>
</li>
<li>
<p><strong>Q: What do I do with following error: “Error in <code><a href="https://duckplyr.tidyverse.org/reference/compute_parquet.html" class="external-link">compute_parquet()</a></code> at […]: ! ?</strong>*</p>
<p>A: It means that your repertoire files have different schemas, i.e., different column names. You have two options.</p>
<p><strong>Option 1:</strong> Check the data and fix the schema. Explore the reason why the data have different schemas. Remove wrong files. Change column names. And try again.</p>
<p><strong>Option 2:</strong> If you know what you are doing, pass argument <code>enforce_schema = FALSE</code> to <code>read_repertoires</code>. The resultant table will have NAs in the place of missing values. But don’t use it without considering the first option. Broken schema usually means that there are some issues in the how the data were processed upstream.</p>
</li>
<li>
<p><strong>Q: <code>immundata</code> is too verbose, I’m tired of all the messages. How to turn them off?</strong></p>
<p>A: Run the following code <code>options(rlib_message_verbosity = "quiet")</code> in the beginning of your R session to turn off messages.</p>
</li>
<li>
<p><strong>Q: I don’t want to use <code>pak</code>, how can I use the good old <code>install.packages</code> or <code>devtools</code>?</strong></p>
<p>A: Nothing will stop you, eh? You are welcome, but I’m not responsible if something won’t work due to issues with dependencies:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CRAN release</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"immundata"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># GitHub release</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"devtools"</span>, <span class="st">"pkgload"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"immunomind/immundata"</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">reload</span><span class="op">(</span><span class="fu">pkgload</span><span class="fu">::</span><span class="fu"><a href="https://pkgload.r-lib.org/reference/inst.html" class="external-link">inst</a></span><span class="op">(</span><span class="st">"immundata"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Development version</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"immunomind/immundata"</span>, ref <span class="op">=</span> <span class="st">"dev"</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">reload</span><span class="op">(</span><span class="fu">pkgload</span><span class="fu">::</span><span class="fu"><a href="https://pkgload.r-lib.org/reference/inst.html" class="external-link">inst</a></span><span class="op">(</span><span class="st">"immundata"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Q: Why are the counts for receptors available only after all the aggregation?</strong></p>
<p>A: Counts and proportions are properties of a receptor inside a specific repertoire. A receptor seen in two samples will be counted twice – once per repertoire. Until receptors and repertoires are defined, any “count” would be ambiguous. That’s why the numbers appear only after <code><a href="reference/agg_receptors.html">agg_receptors()</a></code> and <code><a href="reference/agg_repertoires.html">agg_repertoires()</a></code> have locked those definitions in.</p>
</li>
</ol>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=immundata" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/immunomind/immundata/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/immunomind/immundata/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>Apache License (&gt;= 2)</li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CONTRIBUTING.html">Contributing guide</a></li>
<li><a href="SUPPORT.html">Getting help</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing immundata</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://www.linkedin.com/in/vdnaz" class="external-link">Vadim I. Nazarov</a> <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-3659-2709" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=immundata" class="external-link"><img src="http://www.r-pkg.org/badges/version-ago/immundata?style=flat-square" alt="CRAN"></a></li>
<li><a href="https://www.r-pkg.org/pkg/immundata" class="external-link"><img src="http://cranlogs.r-pkg.org/badges/grand-total/immundata?style=flat-square" alt="Downloads_all"></a></li>
<li><a href="https://www.r-pkg.org/pkg/immundata" class="external-link"><img src="http://cranlogs.r-pkg.org/badges/last-week/immundata?style=flat-square" alt="Downloads_week"></a></li>
<li><a href="https://github.com/immunomind/immundata/issues" class="external-link"><img src="https://img.shields.io/github/issues/immunomind/immundata?style=flat-square" alt="Issues"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.linkedin.com/in/vdnaz" class="external-link">Vadim I. Nazarov</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

      </footer>
</div>






  </body>
</html>
